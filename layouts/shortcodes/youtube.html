{{- /*
Renders an embedded YouTube video.
Compatible with Hugo >= 0.125
*/ -}}

{{- $pc := .Page.Site.Config.Privacy.YouTube }}
{{- if not $pc.Disable }}
  {{- with $id := or (.Get "id") (.Get 0) }}

    {{- /* Defaults */ -}}
    {{- $allowFullScreen := "allowfullscreen" }}
    {{- $autoplay := 0 }}
    {{- $class := "" }}
    {{- $controls := 1 }}
    {{- $end := 0 }}
    {{- $loading := "eager" }}
    {{- $loop := 0 }}
    {{- $mute := 0 }}
    {{- $start := 0 }}
    {{- $title := "YouTube video" }}

    {{- /* Boolean args */ -}}
    {{- if in (slice "true" true 1) ($.Get "autoplay") }}{{ $autoplay = 1 }}{{ end }}
    {{- if in (slice "false" false 0) ($.Get "controls") }}{{ $controls = 0 }}{{ end }}
    {{- if in (slice "true" true 1) ($.Get "loop") }}{{ $loop = 1 }}{{ end }}
    {{- if or (in (slice "true" true 1) ($.Get "mute")) $autoplay }}{{ $mute = 1 }}{{ end }}

    {{- /* Other args */ -}}
    {{- $class = or ($.Get "class") $class }}
    {{- $end = or ($.Get "end") $end }}
    {{- $loading = or ($.Get "loading") $loading }}
    {{- $start = or ($.Get "start") $start }}
    {{- $title = or ($.Get "title") $title }}

    {{- /* Base URL */ -}}
    {{- $host := cond $pc.PrivacyEnhanced "www.youtube-nocookie.com" "www.youtube.com" }}
    {{- $src := printf "https://%s/embed/%s" $host $id }}

    {{- /* Query params: MUST be map[string]string */ -}}
    {{- $params := dict
      "autoplay" (printf "%d" $autoplay)
      "controls" (printf "%d" $controls)
      "end" (printf "%d" $end)
      "mute" (printf "%d" $mute)
      "start" (printf "%d" $start)
      "loop" (printf "%d" $loop)
    }}

    {{- if eq $loop 1 }}
      {{- $params = merge $params (dict "playlist" (printf "%s" $id)) }}
    {{- end }}

    {{- with querify $params }}
      {{- $src = printf "%s?%s" $src . }}
    {{- end }}

    {{- /* Styles */ -}}
    {{- $divStyle := "position:relative;padding-bottom:56.25%;height:0;overflow:hidden;" }}
    {{- $iframeStyle := "position:absolute;top:0;left:0;width:100%;height:100%;border:0;" }}

    {{- if $class }}
      {{- $divStyle = "" }}
      {{- $iframeStyle = "" }}
    {{- end }}

    <div{{ with $class }} class="{{ . }}"{{ end }}{{ with $divStyle }} style="{{ . | safeCSS }}"{{ end }}>
      <iframe
        src="{{ $src }}"
        loading="{{ $loading }}"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        {{- if $allowFullScreen }} allowfullscreen{{ end }}
        {{- with $iframeStyle }} style="{{ . | safeCSS }}"{{ end }}
        title="{{ $title }}"
      ></iframe>
    </div>

  {{- else }}
    {{- errorf "The %q shortcode requires a YouTube id. See %s" .Name .Position }}
  {{- end }}
{{- end }}
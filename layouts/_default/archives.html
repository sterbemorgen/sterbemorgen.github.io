{{- define "main" }}
<div id="heatmap" style="display: block; height: 200px; width: 100%; padding: 2px; text-align: center;"></div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<script type="text/javascript">
    var chartDom = document.getElementById('heatmap');
    var myChart = echarts.init(chartDom);
    window.onresize = function() {
        myChart.resize();
    };

    // 获取日期范围
    function getDateRange(months) {
        var startDate = new Date();
        startDate.setMonth(startDate.getMonth() - months);
        var endDate = new Date();
        
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        
        return [startDateStr, endDateStr];
    }

    // 获取显示的月份数量，根据窗口大小动态调整
    function getMonthCount() {
        const windowWidth = window.innerWidth;
        if (windowWidth >= 600) {
            return 12;
        }
        if (windowWidth >= 400) {
            return 9;
        }
        return 6;
    }

    var postsByDate = new Map();

    // 将文章数据按日期分类
    {{ range ((where .Site.RegularPages "Type" "posts"))  }}
        var date = {{ .Date.Format "2006-01-02" }};
        var postObj = new Map();
        postObj.set("title", {{ .Title }});
        postObj.set("link", {{ .RelPermalink }});

        var data = postsByDate.get(date);
        if (!data) {
            data = new Map();
            data.set("posts", []);
        }
        var posts = data.get("posts");
        posts.push(postObj);
        postsByDate.set(date, data);
    {{- end -}}

    var heatmapData = [];
    for (const [date, data] of postsByDate.entries()) {
        heatmapData.push([date, data.get("posts").length]);
    }

    var option = {
        title: {
            show: true,
            top: 0,
            left: 'center',
            text: 'Languid Logs',
            textStyle: {
                color: '#ffc8c8',  // 粉色
                fontFamily: '"Bubblegum Sans", serif', // 使用你的字体
                fontWeight: 'bold',
                fontSize: 24,  // 字体加大
            },
        },
        legend: {
            show: false,
        },
        visualMap: {
            show: false,
            min: 0,
            max: Math.max(...heatmapData.map(item => item[1])), // 动态计算最大值
            type: 'piecewise',
            splitNumber: 3,
            text: ['posts count', ''],
            showLabel: false,
            orient: 'horizontal',
            left: 'center',
            top: 0,
            itemGap: 10,
            inRange: { color: ['#ff9999', '#ffc7c7', '#ffe2e2'] },
        },
        calendar: {
            top: 80,
            left: 30,
            right: 30,
            cellSize: ['auto', 'auto'], // 使格子变为正方形
            range: getDateRange(getMonthCount()),
            itemStyle: {
                color: 'transparent', // 去除格子的背景
                borderWidth: 1, // 为边框添加宽度
                borderColor: '#ffc8c8', // 粉色边框
            },
            yearLabel: {
                show: false,
            },
            dayLabel: {
                align: 'center',
                nameMap: 'en',
                color: '#ffc8c8',
                fontFamily: 'inherit',
                fontSize: 10, // 调整字体大小
            },
            monthLabel: {
                nameMap: 'en',
                color: '#ffc8c8',
                fontFamily: 'inherit',
                fontSize: 10, // 调整字体大小
            },
            splitLine: {
                show: false,
            },
        },
        tooltip: {
            hideDelay: 1000,
            enterable: true,
            formatter: function(params) {
                const date = params.data[0];
                var content = `<span style="font-size: 1rem;">${date}</span>`;
                const posts = postsByDate.get(date).get("posts");
                for (const [i, post] of posts.entries()) {
                    var link = post.get("link");
                    var title = post.get("title");
                    content += "<br>";
                    content += `<a href="${link}" target="_blank">${title}</a>`;
                }
                return content;
            }
        },
        series: {
            type: 'heatmap',
            coordinateSystem: 'calendar',
            data: heatmapData
        }
    };

    option && myChart.setOption(option);
</script>

<header class="page-header">
  <h1>
    {{ .Title }}
    {{- if (.Param "ShowRssButtonInSectionTermList") }}
    {{- $rss := (.OutputFormats.Get "rss") }}
    {{- if (eq .Kind `page`) }}
    {{- $rss = (.Parent.OutputFormats.Get "rss") }}
    {{- end }}
    {{- with $rss }}
    <a href="{{ .RelPermalink }}" title="RSS" aria-label="RSS">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" height="23">
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
    {{- end }}
    {{- end }}
  </h1>
  {{- if .Description }}
  <div class="post-description">
    {{ .Description }}
  </div>
  {{- end }}
</header>

{{- $pages := where site.RegularPages "Type" "in" site.Params.mainSections }}

{{- if site.Params.ShowAllPagesInArchive }}
{{- $pages = site.RegularPages }}
{{- end }}

{{- range $pages.GroupByPublishDate "2006" }}
{{- if ne .Key "0001" }}
<div class="archive-year">
  {{- $year := replace .Key "0001" "" }}
  <h2 class="archive-year-header" id="{{ $year }}">
    <a class="archive-header-link" href="#{{ $year }}">
      {{- $year -}}
    </a>
    <sup class="archive-count">&nbsp;{{ len .Pages }}</sup>
  </h2>
  {{- range .Pages.GroupByDate "January" }}
  <div class="archive-month">
    <h3 class="archive-month-header" id="{{ $year }}-{{ .Key }}">
      <a class="archive-header-link" href="#{{ $year }}-{{ .Key }}">
        {{- .Key -}}
      </a>
      <sup class="archive-count">&nbsp;{{ len .Pages }}</sup>
    </h3>
    <div class="archive-posts">
      {{- range .Pages }}
      {{- if eq .Kind "page" }}
      <div class="archive-entry">
        <h3 class="archive-entry-title entry-hint-parent">
          {{- .Title | markdownify }}
          {{- if .Draft }}
          <span class="entry-hint" title="Draft">
            <svg xmlns="http://www.w3.org/2000/svg" height="15" viewBox="0 -960 960 960" fill="currentColor">
              <path
                d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
            </svg>
          </span>
          {{- end }}
        </h3>
        <div class="archive-meta">
          {{- partial "post_meta.html" . -}}
        </div>
        <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
      </div>
      {{- end }}
      {{- end }}
    </div>
  </div>
  {{- end }}
</div>
{{- end }}
{{- end }}

{{- end }}{{/* end main */}}
